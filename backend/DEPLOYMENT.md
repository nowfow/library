# Руководство по развертыванию - Музыкальная библиотека Backend

## Обзор реализации

Полностью реализованный backend для музыкальной библиотеки нот валторны включает:

### Основные компоненты

✅ **Express сервер** - основной HTTP сервер с middleware
✅ **MySQL база данных** - с полной схемой и миграциями 
✅ **JWT аутентификация** - система пользователей и ролей
✅ **REST API** - все эндпоинты согласно Wiki
✅ **Файловая система** - управление PDF файлами нот
✅ **Система логирования** - детальное логирование запросов и ошибок
✅ **Валидация данных** - проверка входных данных и безопасность
✅ **Пагинация** - для всех списочных эндпоинтов
✅ **Полнотекстовый поиск** - по произведениям и терминам
✅ **Коллекции пользователей** - личные и публичные коллекции
✅ **Управление терминами** - CRUD операции для музыкальных терминов
✅ **Docker поддержка** - контейнеризация для продакшена
✅ **Тестирование** - набор автоматических тестов API
✅ **Утилиты управления** - скрипты для БД и развертывания

## Структура проекта

```
backend/
├── src/
│   ├── index.js                 # Главный файл сервера
│   ├── db.js                    # Соединение и схема БД  
│   ├── middleware/
│   │   └── auth.js              # JWT аутентификация
│   ├── routes/
│   │   ├── auth.js              # Эндпоинты аутентификации
│   │   ├── works.js             # Управление произведениями
│   │   ├── terms.js             # Управление терминами
│   │   ├── files.js             # Файловая система
│   │   └── collections.js       # Пользовательские коллекции
│   └── utils/
│       ├── logger.js            # Система логирования
│       ├── validation.js        # Валидация данных
│       └── response.js          # Стандартизация ответов
├── scripts/
│   └── db-manager.js            # Утилиты управления БД
├── test/
│   └── test.js                  # Автоматические тесты
├── populate-db.js               # Заполнение БД из файлов
├── package.json                 # Зависимости и скрипты
├── .env.example                 # Пример конфигурации
├── Dockerfile                   # Docker образ
├── docker-compose.yml           # Оркестрация контейнеров
├── Makefile                     # Задачи автоматизации
├── API.md                       # Документация API
└── README.md                    # Основная документация
```

## Быстрый старт

### 1. Установка зависимостей
```bash
cd backend
make setup  # или npm install && cp .env.example .env
```

### 2. Настройка переменных окружения
Отредактируйте файл `.env`:
```env
# База данных
DB_HOST=localhost
DB_PORT=3306  
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=music_library

# JWT секрет
JWT_SECRET=your_super_secret_jwt_key_change_in_production

# Путь к файлам нот
FILES_PATH=../files
```

### 3. Инициализация базы данных
```bash
make db-init  # или npm run db:init
```

### 4. Заполнение данными  
```bash
make db-populate  # или npm run db:populate
```

### 5. Создание администратора
```bash
npm run create-admin admin@example.com admin123 "Администратор"
```

### 6. Запуск сервера
```bash
make dev  # или npm run dev (режим разработки)
make start  # или npm start (продакшн)
```

### 7. Проверка работоспособности
```bash
make test  # или npm test
curl http://localhost:3000/health
```

## Развертывание с Docker

### Разработка
```bash
# Запуск только БД
docker-compose up mysql

# Запуск всего стека
docker-compose up
```

### Продакшн
```bash
# Сборка образа
make docker-build

# Запуск в продакшен режиме  
docker-compose -f docker-compose.yml up -d
```

## Управление базой данных

```bash
# Статус БД
npm run db:status

# Сброс БД (осторожно!)
npm run db:reset  

# Резервная копия
npm run db:backup

# Импорт терминов из CSV
node scripts/db-manager.js import-terms terms.csv
```

## Мониторинг и логи

```bash
# Просмотр логов
make logs

# Статус сервера
make status

# Архивирование логов
make backup-logs
```

## API эндпоинты

### Основные разделы:
- **`/api/auth`** - аутентификация и управление пользователями
- **`/api/works`** - произведения и поиск
- **`/api/terms`** - музыкальные термины
- **`/api/files`** - файловая система и скачивание
- **`/api/collections`** - пользовательские коллекции
- **`/health`** - проверка состояния

Полная документация в файле [API.md](API.md)

## Безопасность

✅ **CORS настроен** для фронтенда
✅ **Rate limiting** - защита от spam-запросов  
✅ **Helmet.js** - базовая защита заголовков
✅ **JWT токены** - безопасная аутентификация
✅ **Bcrypt хеширование** - защита паролей
✅ **Валидация путей** - защита от directory traversal
✅ **Ограничение размера** - защита от больших файлов

## Производительность

✅ **Connection pooling** - эффективная работа с БД
✅ **FULLTEXT индексы** - быстрый поиск
✅ **Compression** - сжатие ответов
✅ **Пагинация** - ограничение размера ответов
✅ **Кеширование** - готово к добавлению Redis

## Масштабирование

✅ **Docker готовность** - легкое развертывание
✅ **Переменные окружения** - гибкая конфигурация  
✅ **Graceful shutdown** - корректное завершение
✅ **Health checks** - мониторинг состояния
✅ **Structured logging** - анализ производительности

## Следующие шаги

1. **Настройка SSL** - для HTTPS в продакшене
2. **Redis кеширование** - для улучшения производительности
3. **Мониторинг** - Prometheus/Grafana метрики
4. **CI/CD** - автоматизация развертывания
5. **Load balancing** - для высокой нагрузки

## Поддержка

При возникновении проблем:

1. Проверьте логи: `make logs`
2. Проверьте статус: `make status`  
3. Проверьте конфигурацию: `make check-env`
4. Запустите тесты: `make test`

## Файловая структура данных

Backend ожидает следующую структуру файлов нот:
```
files/
├── Category1/
│   ├── Composer1/
│   │   └── Work1.pdf
│   └── Subcategory/
│       └── Composer2/
│           └── Work2.pdf
└── Category2/
    └── file.pdf
```

Система автоматически распознает:
- **Категории** - первый уровень папок
- **Подкатегории** - промежуточные папки
- **Композиторы** - предпоследний уровень  
- **Произведения** - названия PDF файлов

Поддерживаемые форматы: PDF, MP3, SIB, MUS